<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#6b5cff" />
  <meta name="description" content="Tic‑Tac‑Toe+ — solo, local ou en ligne via WebRTC (P2P), mobile-first, thème auto, accessibilité et micro‑interactions." />
  <link rel="icon" href="assets/icon.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.webmanifest">
  <title>Tic‑Tac‑Toe+ • 2025</title>
  <style>
    /* === Design tokens (OKLCH, mobile-first) === */
    :root{
      --bg:            oklch(98% 0.01 250);
      --bg-2:          oklch(96% 0.02 250);
      --surface:       oklch(98% 0.01 250 / .6);
      --surface-strong:oklch(96% 0.02 250 / .65);
      --text:          oklch(21% 0.02 250);
      --muted:         oklch(45% 0.03 250);
      --line:          oklch(85% 0.02 250);
      --accent:        oklch(63% 0.23 275);
      --accent-600:    oklch(57% 0.23 275);
      --accent-700:    oklch(50% 0.23 275);
      --accent-300:    oklch(75% 0.12 275);
      --accent-ghost:  oklch(63% 0.23 275 / .12);
      --x-color:       oklch(62% 0.24 330);
      --o-color:       oklch(67% 0.18 210);
      --s-1:8px;--s-2:12px;--s-3:16px;--s-4:24px;--s-5:32px;--s-6:48px;--s-7:64px;
      --r-2:12px;--r-3:16px;--r-4:20px;--r-5:28px;
      --shadow-soft:0 10px 30px -12px rgb(0 0 0 / .25);
      --shadow-lift:0 12px 40px -16px rgb(0 0 0 / .35);
      --glass-blur:14px;
      --title: clamp(1.15rem, .9rem + 2.2vw, 2rem);
      --subtitle: clamp(.9rem, .8rem + .8vw, 1.125rem);
      --body: clamp(16px, .95rem + .2vw, 18px);
      --t-fast:120ms;--t-med:220ms;--t-slow:380ms;
      --spring-1:cubic-bezier(.2,.8,.2,1.2);
      --spring-2:cubic-bezier(.16,.9,.15,1.4);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: oklch(16% 0.03 260); --bg-2: oklch(20% 0.04 260);
        --surface: oklch(18% 0.03 260 / .5); --surface-strong: oklch(20% 0.04 260 / .6);
        --text: oklch(94% 0.02 250); --muted: oklch(75% 0.03 250); --line: oklch(40% 0.03 260);
        --accent: oklch(70% 0.24 275); --accent-600: oklch(63% 0.24 275); --accent-700: oklch(57% 0.24 275); --accent-300: oklch(82% 0.14 275);
        --accent-ghost: oklch(70% 0.24 275 / .18); --x-color: oklch(70% 0.26 330); --o-color: oklch(75% 0.18 210);
        --shadow-soft:0 18px 60px -18px rgb(0 0 0 / .6); --shadow-lift:0 20px 80px -24px rgb(0 0 0 / .7);
      }
    }

    /* === Base === */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 400 var(--body)/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1100px 480px at 10% -10%, var(--accent-ghost), transparent 60%),
        radial-gradient(1100px 480px at 90% -10%, var(--accent-ghost), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      min-height:100dvh; min-height:100svh;
    }
    button{font:inherit;color:inherit}
    :focus-visible{outline:3px solid var(--accent-300); outline-offset:2px; border-radius:10px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

    /* === Layout === */
    .app{
      max-width:1440px; margin:0 auto;
      display:grid; grid-template-rows:auto 1fr auto;
      min-height:100%;
      padding: max(var(--s-3), env(safe-area-inset-top)) max(var(--s-3), env(safe-area-inset-right)) max(var(--s-4), env(safe-area-inset-bottom)) max(var(--s-3), env(safe-area-inset-left));
      gap: var(--s-3);
    }
    .appbar{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; justify-content:space-between;
      padding: var(--s-2) var(--s-3);
      background: linear-gradient(180deg, var(--surface), transparent);
      backdrop-filter: blur(var(--glass-blur));
      border-radius: var(--r-4); box-shadow: var(--shadow-soft);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand svg{width:26px;height:26px}
    .brand h1{font-size:var(--title);margin:0;letter-spacing:.2px}
    .app-actions{display:flex;gap:8px}
    .iconbtn,.btn,.cell{touch-action:manipulation;-webkit-tap-highlight-color:transparent}

    .iconbtn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      height:40px;min-width:40px;padding:0 12px;
      background: color-mix(in oklab, var(--surface-strong) 70%, transparent);
      border:1px solid var(--line); border-radius:12px; cursor:pointer;
      transition: transform var(--t-med) var(--spring-1), box-shadow var(--t-med) ease, background var(--t-fast) ease, opacity var(--t-fast) ease;
      backdrop-filter: blur(var(--glass-blur));
    }
    .iconbtn:hover{transform:translateY(-2px); box-shadow:var(--shadow-soft)}
    .iconbtn:active{transform:translateY(0)}
    .iconbtn svg{width:20px;height:20px}
    .iconbtn .label{font-size:.95rem}

    /* Status + progression */
    .statusbar{
      display:flex; gap: var(--s-2); align-items:center; justify-content:space-between;
      padding: var(--s-2) var(--s-3);
      background: color-mix(in oklab, var(--surface) 90%, transparent);
      border:1px solid var(--line); border-radius:var(--r-4);
      box-shadow:var(--shadow-soft); backdrop-filter: blur(var(--glass-blur));
      flex-wrap:wrap;
    }
    .turn{display:flex;align-items:center;gap:10px;font-weight:600;letter-spacing:.2px}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background: color-mix(in oklab, var(--surface-strong) 80%, transparent);
      border:1px solid var(--line); min-height:28px; font-variant-numeric:tabular-nums;
      transition: box-shadow var(--t-fast) ease, transform var(--t-fast) ease, background var(--t-fast) ease;
    }
    .chip svg{width:18px;height:18px}
    .chip.dot::before{
      content:""; width:8px; height:8px; border-radius:999px; background: var(--muted);
      box-shadow:0 0 0 2px color-mix(in oklab, var(--surface-strong) 80%, transparent);
    }
    .chip.good.dot::before{background: var(--accent)}
    .progress{position:relative;flex:1;min-width:160px;height:8px;border-radius:999px;overflow:hidden;background: color-mix(in oklab, var(--line) 50%, transparent)}
    .progress>i{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg, var(--accent-300), var(--accent));transition: inset var(--t-slow) var(--spring-1)}

    /* Plateau */
    .card{
      position:relative;margin-inline:auto;width:min(100%, 560px);
      padding: clamp(var(--s-3), 4vw, var(--s-6));
      background: color-mix(in oklab, var(--surface) 88%, transparent);
      border:1px solid var(--line); border-radius:var(--r-5);
      box-shadow:var(--shadow-lift); backdrop-filter: blur(var(--glass-blur));
      display:grid; gap: var(--s-3);
    }
    .board{display:grid;gap: clamp(8px, 3.5vw, 16px); grid-template-columns:repeat(3,1fr)}
    .cell{
      position:relative; aspect-ratio:1 / 1;
      border:1px solid var(--line); border-radius:18px;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--surface-strong) 80%, transparent), transparent),
        radial-gradient(150% 100% at 50% -10%, var(--accent-ghost), transparent 45%);
      box-shadow: inset 0 1px 0 rgb(255 255 255 / .08);
      display:grid;place-items:center;cursor:pointer;
      transition: transform var(--t-med) var(--spring-2), border-color var(--t-fast) ease, background var(--t-fast) ease, opacity var(--t-fast) ease;
      user-select:none;
    }
    .cell:hover{transform:translateY(-3px)}
    .cell:active{transform:scale(.98)}
    .cell[disabled]{opacity:.6;cursor:not-allowed;transform:none}
    body[data-online="on"][data-canplay="no"] .cell{cursor:not-allowed;opacity:.85}

    .mark{width:62%;height:62%;stroke-linecap:round;stroke-linejoin:round;stroke-width:10;fill:none;}
    .mark.x{stroke:var(--x-color)} .mark.o{stroke:var(--o-color)}
    .cell.win{box-shadow:0 0 0 3px var(--accent-300), inset 0 0 0 999px color-mix(in oklab, var(--accent-ghost) 40%, transparent)}
    .cell.win .mark{filter:drop-shadow(0 4px 14px color-mix(in oklab, var(--accent) 60%, transparent))}

    .actions{display:flex;flex-wrap:wrap;gap: var(--s-2);justify-content:space-between;align-items:center}
    .btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:linear-gradient(180deg,var(--accent),var(--accent-600));
      color:white;font-weight:600;letter-spacing:.2px;
      box-shadow:0 8px 20px -10px color-mix(in oklab, var(--accent) 50%, transparent);
      cursor:pointer;transition: transform var(--t-med) var(--spring-1), box-shadow var(--t-med) ease, opacity var(--t-fast) ease;
    }
    .btn:hover{transform:translateY(-2px)} .btn:active{transform:translateY(0)}
    .btn.ghost{background: color-mix(in oklab, var(--surface-strong) 80%, transparent); color:var(--text); box-shadow:none}
    .btn[disabled], .iconbtn[disabled]{opacity:.6;cursor:not-allowed}

    .empty{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;transition: opacity var(--t-slow) ease}
    .empty.hide{opacity:0}
    .empty .cardlet{
      display:grid;gap:10px;place-items:center;text-align:center;
      padding:18px 16px;background: color-mix(in oklab, var(--surface) 90%, transparent);
      border:1px solid var(--line);border-radius:16px;backdrop-filter: blur(var(--glass-blur));
    }
    .empty svg{width:56px;height:56px}
    footer{opacity:.8;text-align:center;font-size:.9rem}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%) translateY(20px);
      background: color-mix(in oklab, var(--surface-strong) 95%, transparent);
      border:1px solid var(--line); border-radius:999px; padding:10px 14px;
      box-shadow:var(--shadow-soft); backdrop-filter: blur(var(--glass-blur));
      opacity:0; pointer-events:none;
      transition:opacity var(--t-med) ease, transform var(--t-med) var(--spring-1);
      z-index:100;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* Tour actif */
    body[data-turn="X"] #xScore{box-shadow:0 0 0 2px color-mix(in oklab, var(--x-color) 70%, transparent) inset}
    body[data-turn="O"] #oScore{box-shadow:0 0 0 2px color-mix(in oklab, var(--o-color) 70%, transparent) inset}

    @keyframes pop{0%{transform:scale(.6);opacity:.2}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}
    .pop{animation: pop var(--t-slow) var(--spring-1)}

    /* Tactile & motion */
    @media (pointer: coarse){
      .cell:hover,.btn:hover,.iconbtn:hover{transform:none}
    }
    @media (prefers-reduced-motion: reduce){
      .iconbtn,.btn,.cell{transition:none}
      .pop{animation:none}
    }

    /* Modal en ligne */
    .modal{position:fixed;inset:0;display:grid;place-items:center;background:rgb(0 0 0 / .35);backdrop-filter:saturate(120%) blur(2px);opacity:0;pointer-events:none;transition:opacity var(--t-slow) ease;z-index:50}
    .modal[open]{opacity:1;pointer-events:auto}
    .modal-card{
      width:min(100%, 720px);
      margin:0 var(--s-3);
      background: color-mix(in oklab, var(--surface) 96%, transparent);
      border:1px solid var(--line);
      border-radius:var(--r-5);
      box-shadow:var(--shadow-lift);
      backdrop-filter:blur(var(--glass-blur));
      padding: clamp(var(--s-4), 3vw, var(--s-6));
      display:grid; gap: var(--s-3);
      position:relative;
    }
    .modal-card header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .modal-card h2{margin:0;font-size:clamp(1rem,.9rem + .9vw,1.35rem)}
    .tabs{display:flex;gap:8px}
    .tabs .t{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background: color-mix(in oklab, var(--surface-strong) 80%, transparent);cursor:pointer}
    .tabs .t[aria-selected="true"]{box-shadow:0 0 0 2px var(--accent-300) inset}

    .grid{display:grid;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}
    textarea, input[type="text"]{
      width:100%; min-height:92px; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background: color-mix(in oklab, var(--surface-strong) 85%, transparent);
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.9rem;
      resize:vertical;
    }
    .note{font-size:.9rem;opacity:.8}
    .closebtn{position:absolute;top:12px;right:12px}

    /* === Fallback sans OKLCH / color-mix === */
    @supports not (color: oklch(50% 0 0)) or not (background: color-mix(in oklab, #000 10%, transparent)) {
      :root{
        --bg:#f6f7fb; --bg-2:#eef1f8; --surface: rgba(255,255,255,.70); --surface-strong: rgba(255,255,255,.78);
        --text:#1b1d22; --muted:#6b7280; --line:#d8dbe6; --accent:#6b5cff; --accent-600:#5b4eff; --accent-700:#4a3cf4; --accent-300:#a3a9ff;
        --accent-ghost: rgba(107,92,255,.12); --x-color:#ff4db8; --o-color:#2f92ff;
      }
      @media (prefers-color-scheme: dark){
        :root{
          --bg:#161821; --bg-2:#1b1f2a; --surface: rgba(24,27,38,.55); --surface-strong: rgba(28,31,44,.60);
          --text:#f2f3f7; --muted:#a8b0c2; --line:#343a4a; --accent:#7a6dff; --accent-600:#6a5eff; --accent-700:#5a4eef; --accent-300:#b9bfff;
          --accent-ghost: rgba(122,109,255,.18); --x-color:#ff62c8; --o-color:#6aa8ff;
        }
      }
      body{background:linear-gradient(180deg,var(--bg),var(--bg-2))}
      .appbar{background:linear-gradient(180deg,var(--surface),transparent)}
      .statusbar,.card,.chip,.modal-card{background:var(--surface)}
      .iconbtn{background:var(--surface-strong)}
      .cell{background:linear-gradient(180deg,var(--surface-strong),transparent), radial-gradient(150% 100% at 50% -10%, var(--accent-ghost), transparent 45%)}
      .progress{background:rgba(0,0,0,.10)}
      .progress>i{background:linear-gradient(90deg,var(--accent-300),var(--accent))}
      .cell.win{box-shadow:0 0 0 3px var(--accent-300), inset 0 0 0 999px var(--accent-ghost)}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="appbar" role="banner" aria-label="Barre d’application">
      <div class="brand" aria-label="Tic‑Tac‑Toe+">
        <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M8 3v18M16 3v18M3 8h18M3 16h18"/></g></svg>
        <h1>Tic‑Tac‑Toe+</h1>
      </div>
      <div class="app-actions">
        <button class="iconbtn" id="onlineBtn" type="button" aria-haspopup="dialog" aria-controls="onlineModal">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><path d="M4 7h16M4 12h16M4 17h16"/></g></svg>
          <span class="label">En ligne</span>
        </button>
        <button class="iconbtn" id="soundBtn" type="button" aria-pressed="false" aria-label="Activer les sons">
          <svg id="soundOn" viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M4 10v4a1 1 0 0 0 1 1h2l3.5 3V6L7 9H5a1 1 0 0 0-1 1Z"/><path d="M15 9a4 4 0 0 1 0 6M18 7a7 7 0 0 1 0 10"/></g></svg>
          <svg id="soundOff" viewBox="0 0 24 24" style="display:none" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M4 10v4a1 1 0 0 0 1 1h2l3.5 3V6L7 9H5a1 1 0 0 0-1 1Z"/><path d="M16 8l5 5M21 8l-5 5"/></g></svg>
          <span class="label">Sons</span>
        </button>
        <button class="iconbtn" id="resetSeriesBtn" type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M19 8a7 7 0 1 0 2 5"/><path d="M19 4v4h-4"/></g></svg>
          <span class="label">Nouvelle série</span>
        </button>
      </div>
    </header>

    <section class="statusbar" role="status" aria-live="polite">
      <div class="turn" id="turnLabel">C’est à <strong>X</strong> de jouer.</div>
      <div class="progress" id="progress" role="progressbar" aria-label="Progression du tour" aria-valuemin="0" aria-valuemax="9" aria-valuenow="0"><i id="progressFill"></i></div>
      <div class="scores" style="display:flex;gap:8px">
        <span class="chip" id="xScore" aria-current="true"><svg viewBox="0 0 24 24" aria-hidden="true"><g class="mark x" stroke="currentColor" stroke-width="2.6"><path d="M6 6L18 18M18 6L6 18"/></g></svg> <b>X</b>: <span data-anim="num">0</span></span>
        <span class="chip" id="oScore" aria-current="false"><svg viewBox="0 0 24 24" aria-hidden="true"><circle class="mark o" cx="12" cy="12" r="7" stroke="currentColor" stroke-width="2.6" fill="none"/></svg> <b>O</b>: <span data-anim="num">0</span></span>
        <span class="chip" id="dScore"><svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M4 12h16"/></g></svg> <b>Nuls</b>: <span data-anim="num">0</span></span>
      </div>
      <div class="row" style="gap:8px">
        <span class="chip" id="youChip" title="Votre symbole">Vous : X</span>
        <span class="chip dot" id="netChip" title="Statut réseau">Hors ligne</span>
      </div>
    </section>

    <main class="card" role="region" aria-label="Plateau de jeu">
      <div class="empty" id="emptyState" aria-hidden="false">
        <div class="cardlet" id="hint">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity=".9"><rect x="3.5" y="3.5" width="17" height="17" rx="3"/><path d="M8 3.5v17M16 3.5v17M3.5 8h17M3.5 16h17"/></g></svg>
          <div style="font-weight:700">Tape une case pour commencer</div>
          <div style="opacity:.8">Tournez tour à tour. Trois symboles alignés, et c’est gagné.</div>
        </div>
      </div>

      <div class="board" id="board" role="grid" aria-label="Grille 3 par 3" aria-rowcount="3" aria-colcount="3" aria-describedby="hint">
        <button class="cell" type="button" aria-label="Case 1" role="gridcell" aria-rowindex="1" aria-colindex="1" data-index="0"></button>
        <button class="cell" type="button" aria-label="Case 2" role="gridcell" aria-rowindex="1" aria-colindex="2" data-index="1"></button>
        <button class="cell" type="button" aria-label="Case 3" role="gridcell" aria-rowindex="1" aria-colindex="3" data-index="2"></button>
        <button class="cell" type="button" aria-label="Case 4" role="gridcell" aria-rowindex="2" aria-colindex="1" data-index="3"></button>
        <button class="cell" type="button" aria-label="Case 5" role="gridcell" aria-rowindex="2" aria-colindex="2" data-index="4"></button>
        <button class="cell" type="button" aria-label="Case 6" role="gridcell" aria-rowindex="2" aria-colindex="3" data-index="5"></button>
        <button class="cell" type="button" aria-label="Case 7" role="gridcell" aria-rowindex="3" aria-colindex="1" data-index="6"></button>
        <button class="cell" type="button" aria-label="Case 8" role="gridcell" aria-rowindex="3" aria-colindex="2" data-index="7"></button>
        <button class="cell" type="button" aria-label="Case 9" role="gridcell" aria-rowindex="3" aria-colindex="3" data-index="8"></button>
      </div>

      <div class="actions">
        <div class="hint" style="opacity:.8">Astuce : flèches + Entrée/Espace. R = Rejouer · Z = Annuler.</div>
        <div style="display:flex; gap:10px">
          <button class="btn ghost" id="undoBtn" type="button" disabled>
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M7 7H3v4"/><path d="M21 17a8 8 0 0 0-8-8H3"/></g></svg>
            Annuler
          </button>
          <button class="btn" id="resetBtn" type="button">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></g></svg>
            Rejouer
          </button>
        </div>
      </div>
      <div id="live" class="sr-only" aria-live="polite"></div>
    </main>

    <footer>Fait avec ♥ — solo, local ou en ligne (P2P). Thème auto, a11y et micro‑interactions.</footer>
  </div>

  <!-- Modal en ligne -->
  <div class="modal" id="onlineModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="onlineTitle">
    <div class="modal-card" role="document">
      <header>
        <h2 id="onlineTitle">Jouer en ligne (P2P)</h2>
        <button class="iconbtn closebtn" id="closeModal" type="button" aria-label="Fermer">
          <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"><path d="M6 6l12 12M18 6L6 18"/></g></svg>
        </button>
      </header>

      <div class="row" style="align-items:flex-end">
        <div style="flex:1">
          <label for="nick">Ton pseudo (facultatif)</label>
          <input id="nick" type="text" placeholder="Ex. Alex" inputmode="text" autocomplete="nickname" />
        </div>
        <div class="chip" id="sideChip">Tu joueras : X (hôte) · O (invité)</div>
      </div>

      <nav class="tabs" role="tablist" aria-label="Connexion">
        <button class="t" id="tabHost" role="tab" aria-selected="true" aria-controls="panelHost">Créer</button>
        <button class="t" id="tabJoin" role="tab" aria-selected="false" aria-controls="panelJoin">Rejoindre</button>
      </nav>

      <!-- Panneau Hôte -->
      <section id="panelHost" class="grid" role="tabpanel" aria-labelledby="tabHost">
        <div class="row">
          <button class="btn" id="hostCreateBtn" type="button" title="Créer une offre WebRTC">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><path d="M12 5v14M5 12h14"/></g></svg>
            Créer une invitation (X)
          </button>
        </div>

        <label for="hostOffer">Code d’invitation (si besoin)</label>
        <textarea id="hostOffer" readonly placeholder="Clique sur « Créer une invitation »"></textarea>

        <div class="row">
          <label for="hostOfferLink" style="flex:1">Lien d’invitation (plus simple)</label>
          <button class="iconbtn" id="hostCopyLinkBtn" type="button" disabled title="Copier le lien d’invitation">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><rect x="8" y="8" width="10" height="10" rx="2"/><path d="M6 6h8a2 2 0 0 1 2 2v0"/></g></svg>
            <span class="label">Copier lien</span>
          </button>
          <button class="iconbtn" id="hostShareBtn" type="button" disabled title="Partager">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><path d="M12 5v14M5 12h14"/></g></svg>
            <span class="label">Partager</span>
          </button>
        </div>
        <textarea id="hostOfferLink" readonly placeholder="Le lien apparaîtra ici après création"></textarea>

        <label for="guestAnswer">Colle ici la réponse de l’invité (ou ouvre son lien de réponse)</label>
        <textarea id="guestAnswer" placeholder="Réponse de l’invité (coller ici)"></textarea>
        <div class="row">
          <button class="btn" id="applyAnswerBtn" type="button" disabled>Valider la réponse</button>
          <span class="note">Astuce : si tu ouvres le <b>lien de réponse</b> de l’invité, la validation se fait automatiquement.</span>
        </div>
      </section>

      <!-- Panneau Invité -->
      <section id="panelJoin" class="grid" role="tabpanel" aria-labelledby="tabJoin" hidden>
        <label for="hostOfferInput">Colle l’invitation reçue (ou ouvre directement le lien d’invitation)</label>
        <textarea id="hostOfferInput" placeholder="Invitation de l’hôte (coller ici)"></textarea>
        <div class="row">
          <button class="btn" id="joinApplyOfferBtn" type="button">Générer ma réponse (O)</button>
        </div>

        <label for="joinAnswer">Ma réponse (si besoin de texte)</label>
        <textarea id="joinAnswer" readonly placeholder="Clique d’abord sur « Générer ma réponse »"></textarea>

        <div class="row">
          <label for="joinAnswerLink" style="flex:1">Lien de réponse (plus simple)</label>
          <button class="iconbtn" id="joinCopyLinkBtn" type="button" disabled title="Copier le lien de réponse">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><rect x="8" y="8" width="10" height="10" rx="2"/><path d="M6 6h8a2 2 0 0 1 2 2v0"/></g></svg>
            <span class="label">Copier lien</span>
          </button>
          <button class="iconbtn" id="joinShareBtn" type="button" disabled title="Partager">
            <svg viewBox="0 0 24 24" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.7"><path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 0 1 7 7l-1 1"/><path d="M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 1 1-7-7l1-1"/></g></svg>
            <span class="label">Partager</span>
          </button>
        </div>
        <textarea id="joinAnswerLink" readonly placeholder="Le lien apparaîtra ici après génération"></textarea>
      </section>

      <p class="note">
        Lien = plus simple. S’il est trop long pour une messagerie, utilisez les codes texte juste au-dessus.
        Pas de serveur TURN ici : si le réseau est trop strict, la connexion P2P peut échouer — rejouez en local.
      </p>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // === Sélecteurs ===
    const boardEl = document.getElementById('board');
    const cells = Array.from(boardEl.querySelectorAll('.cell'));
    const turnLabel = document.getElementById('turnLabel');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const emptyState = document.getElementById('emptyState');
    const resetBtn = document.getElementById('resetBtn');
    const resetSeriesBtn = document.getElementById('resetSeriesBtn');
    const undoBtn = document.getElementById('undoBtn');
    const xScoreEl = document.querySelector('#xScore [data-anim="num"]');
    const oScoreEl = document.querySelector('#oScore [data-anim="num"]');
    const dScoreEl = document.querySelector('#dScore [data-anim="num"]');
    const xChip = document.getElementById('xScore');
    const oChip = document.getElementById('oScore');
    const youChip = document.getElementById('youChip');
    const netChip = document.getElementById('netChip');

    const soundBtn = document.getElementById('soundBtn');
    const soundOnIcon = document.getElementById('soundOn');
    const soundOffIcon = document.getElementById('soundOff');
    const onlineBtn = document.getElementById('onlineBtn');

    const modal = document.getElementById('onlineModal');
    const closeModalBtn = document.getElementById('closeModal');
    const nickInput = document.getElementById('nick');
    const sideChip = document.getElementById('sideChip');

    const tabHost = document.getElementById('tabHost');
    const tabJoin = document.getElementById('tabJoin');
    const panelHost = document.getElementById('panelHost');
    const panelJoin = document.getElementById('panelJoin');

    const hostCreateBtn = document.getElementById('hostCreateBtn');
    const hostOfferTA = document.getElementById('hostOffer');
    const hostOfferLinkTA = document.getElementById('hostOfferLink');
    const hostCopyLinkBtn = document.getElementById('hostCopyLinkBtn');
    const hostShareBtn = document.getElementById('hostShareBtn');

    const guestAnswerTA = document.getElementById('guestAnswer');
    const applyAnswerBtn = document.getElementById('applyAnswerBtn');

    const hostOfferInputTA = document.getElementById('hostOfferInput');
    const joinAnswerTA = document.getElementById('joinAnswer');
    const joinAnswerLinkTA = document.getElementById('joinAnswerLink');
    const joinCopyLinkBtn = document.getElementById('joinCopyLinkBtn');
    const joinShareBtn = document.getElementById('joinShareBtn');
    const joinApplyOfferBtn = document.getElementById('joinApplyOfferBtn');

    const live = document.getElementById('live');
    const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    const STORAGE_KEY = 'ttt+';
    const NICK_KEY = 'ttt+nick';

    // === État local ===
    let state = {
      board: Array(9).fill(null),
      player: 'X',
      starter: 'X',
      moves: 0,
      history: [],
      scores: {X:0, O:0, D:0},
      sounds: true,
      lock: false
    };

    // === Réseau ===
    const online = {
      enabled: false,
      role: null,    // 'host' | 'guest' | null
      side: 'X',     // 'X' (host) ou 'O' (guest)
      pc: null,
      dc: null,
      ping: null,
      pingTimer: null,
      nick: '',
      peerNick: '',
      connected: false
    };

    // === Audio & haptics ===
    const Audio = (() => {
      let ctx;
      const on = () => state.sounds;
      function ping(f=520, d=.06){
        if(!on()) return;
        ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
        const t = ctx.currentTime, o = ctx.createOscillator(), g = ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(f, t);
        g.gain.setValueAtTime(.0001, t);
        g.gain.exponentialRampToValueAtTime(.06, t+.01);
        g.gain.exponentialRampToValueAtTime(.0001, t+d);
        o.connect(g).connect(ctx.destination);
        o.start(t); o.stop(t+d);
      }
      return { ping };
    })();
    const haptic = (pattern) => {
      try{
        if(window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        navigator.vibrate && navigator.vibrate(pattern);
      }catch{}
    };

    // === Helpers UI ===
    function setTurnLabel(txt){
      turnLabel.innerHTML = txt;
      live.textContent = txt.replace(/<[^>]+>/g,'');
      document.body.dataset.turn = state.player;
      xChip.setAttribute('aria-current', state.player==='X' ? 'true' : 'false');
      oChip.setAttribute('aria-current', state.player==='O' ? 'true' : 'false');
      updatePlayableHint();
    }
    function updatePlayableHint(){
      if(online.connected){
        const can = state.player===online.side && !state.lock;
        document.body.dataset.online = 'on';
        document.body.dataset.canplay = can ? 'yes' : 'no';
        youChip.textContent = `Vous : ${online.side}`;
      }else{
        delete document.body.dataset.online;
        delete document.body.dataset.canplay;
        youChip.textContent = `Vous : ${state.player}`;
      }
    }
    function updateProgress(){
      const pct = Math.min(state.moves/9,1);
      progressFill.style.insetInlineEnd = `${100 - pct*100}%`;
      progress.setAttribute('aria-valuenow', String(state.moves));
    }
    function svgMark(m){
      return m==='X'
        ? '<svg class="mark x pop" viewBox="0 0 100 100" aria-hidden="true"><path d="M22 22L78 78M78 22L22 78"/></svg>'
        : '<svg class="mark o pop" viewBox="0 0 100 100" aria-hidden="true"><circle cx="50" cy="50" r="28"/></svg>';
    }
    function animateNum(el){
      const target = +el.textContent + 1, start = performance.now(), sVal = target-1, dur = 420;
      function tick(t){
        const p = Math.min(1,(t-start)/dur), e = p<.5 ? 2*p*p : -1+(4-2*p)*p;
        el.textContent = Math.round(sVal + (target-sVal)*e);
        if(p<1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }
    function renderScores(){ xScoreEl.textContent = state.scores.X; oScoreEl.textContent = state.scores.O; dScoreEl.textContent = state.scores.D; }
    function updateSoundUI(){
      soundBtn.setAttribute('aria-pressed', String(state.sounds));
      soundOnIcon.style.display = state.sounds ? '' : 'none';
      soundOffIcon.style.display = state.sounds ? 'none' : '';
      soundBtn.setAttribute('aria-label', state.sounds ? 'Couper les sons' : 'Activer les sons');
    }
    function setNetChip(text, good=false){
      netChip.textContent = text;
      netChip.classList.toggle('good', good);
    }
    const toastEl = document.getElementById('toast');
    function showToast(text){
      toastEl.textContent = text;
      toastEl.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toastEl.classList.remove('show'), 1300);
    }
    // Copie robuste (Clipboard API + fallback execCommand + prompt)
    async function copyAny(text, el){
      try{
        await navigator.clipboard.writeText(text);
        el && (el.style.opacity='.7', setTimeout(()=>el.style.opacity='',500));
        showToast('Lien copié');
        return true;
      }catch(e){
        // fallback
        try{
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly','');
          ta.style.position='fixed'; ta.style.opacity='0'; ta.style.inset='0';
          document.body.appendChild(ta);
          ta.select(); ta.setSelectionRange(0, ta.value.length);
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          if(ok){ showToast('Lien copié'); return true; }
        }catch{}
        // Dernier recours
        prompt('Copie ce texte :', text);
        return false;
      }
    }
    async function shareUrlOrCopy(url, el, text=''){
      if(navigator.share){
        try{
          await navigator.share({url, text});
          return true;
        }catch(e){
          // annulé ou non support de la taille → on tente la copie
        }
      }
      return copyAny(url, el);
    }

    // === Base64 URL‑safe (supporte base64 et base64url) ===
    const encode = (obj) => {
      const json = JSON.stringify(obj);
      const bytes = new TextEncoder().encode(json);
      let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin);
    };
    function toUrlSafe(b64){ return b64.replaceAll('+','-').replaceAll('/','_').replace(/=+$/,''); }
    function fromUrlSafe(b64u){
      let s = b64u.replaceAll('-','+').replaceAll('_','/');
      while(s.length % 4) s += '=';
      return s;
    }
    function decode(str) {
      // accepte base64 classique ou base64url
      const std = /^[A-Za-z0-9+/=]+$/.test(str.trim()) ? str.trim() : fromUrlSafe(str.trim());
      const bin = atob(std);
      const bytes = new Uint8Array([...bin].map(ch=>ch.charCodeAt(0)));
      const json = new TextDecoder().decode(bytes);
      return JSON.parse(json);
    }

    // Liens d’invitation / réponse (hash pour éviter les logs côté serveur)
    const baseLink = () => {
      const u = new URL(location.href);
      u.search = ''; // on nettoie
      u.hash = '';
      return u.toString();
    };
    const makeInviteLink = (payload) => `${baseLink()}#offer=${toUrlSafe(encode(payload))}`;
    const makeAnswerLink = (payload) => `${baseLink()}#answer=${toUrlSafe(encode(payload))}`;

    // === Persistence ===
    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          scores: state.scores,
          sounds: state.sounds,
          starter: state.starter,
          board: state.board,
          player: state.player,
          moves: state.moves,
          history: state.history
        }));
      }catch{}
      renderScores(); updateSoundUI();
    }
    function hydrateBoard(){
      cells.forEach((c,i) => {
        const v = state.board[i];
        c.innerHTML = v ? svgMark(v) : '';
        c.disabled = !!v || state.lock;
        c.classList.remove('win');
        c.setAttribute('aria-label', v ? `Case ${i+1}, ${v}` : `Case ${i+1}`);
      });
      const win = checkWin();
      if(win){
        state.lock = true;
        win.combo.forEach(i=>{
          cells[i].classList.add('win');
          cells[i].disabled = true;
          cells[i].setAttribute('aria-label', `Case ${i+1}, ${state.board[i]}, gagnante`);
        });
        setTurnLabel(`Victoire de <strong>${win.player}</strong> !`);
      }else if(state.moves===9){
        state.lock = true;
        setTurnLabel(`Match <strong>nul</strong>.`);
      }else{
        setTurnLabel(`C’est à <strong>${state.player}</strong> de jouer.`);
      }
      emptyState.classList.toggle('hide', state.moves>0);
      updateProgress();
      renderScores(); updateSoundUI();
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const d = JSON.parse(raw);
          if(d.scores) state.scores = d.scores;
          if(typeof d.sounds === 'boolean') state.sounds = d.sounds;
          if(d.starter) state.starter = d.starter;
          if(Array.isArray(d.board)) state.board = d.board;
          if(d.player) state.player = d.player;
          if(Number.isInteger(d.moves)) state.moves = d.moves;
          if(Array.isArray(d.history)) state.history = d.history;
        }
      }catch{}
      hydrateBoard();
    }

    // === Jeu (source: 'local' | 'remote') ===
    function placeMark(idx, source='local'){
      if(state.lock || state.board[idx]) return;

      if(source==='local' && online.connected){
        if(state.player !== online.side){
          Audio.ping(280,.05); haptic(8);
          return;
        }
      }

      emptyState.classList.add('hide'); undoBtn.disabled = false;

      state.board[idx] = state.player; state.history.push(idx); state.moves++;
      cells[idx].innerHTML = svgMark(state.player);
      cells[idx].setAttribute('aria-label', `Case ${idx+1}, ${state.player}`);
      cells[idx].disabled = true;

      Audio.ping(state.player==='X' ? 560 : 420);
      haptic(10);

      const win = checkWin();
      if(win){ endGame(win, source); }
      else if(state.moves===9){ endGame(null, source); }
      else{
        state.player = state.player==='X' ? 'O' : 'X';
        setTurnLabel(`C’est à <strong>${state.player}</strong> de jouer.`);
      }
      updateProgress(); save();

      if(online.connected && source==='local'){
        send({t:'move', i: idx});
      }
    }
    function checkWin(){
      for(const [a,b,c] of WINS){
        const v = state.board[a];
        if(v && v===state.board[b] && v===state.board[c]) return {combo:[a,b,c], player:v};
      }
      return null;
    }
    function endGame(result, source='local'){
      state.lock = true;
      if(result){
        state.scores[result.player]++; animateNum(result.player==='X' ? xScoreEl : oScoreEl);
        setTurnLabel(`Victoire de <strong>${result.player}</strong> !`);
        for(const i of result.combo){
          cells[i].classList.add('win');
          cells[i].setAttribute('aria-label', `Case ${i+1}, ${state.board[i]}, gagnante`);
        }
        Audio.ping(760,.09); setTimeout(()=>Audio.ping(940,.09),80); haptic([12,60,12]);
      }else{
        state.scores.D++; animateNum(dScoreEl);
        setTurnLabel(`Match <strong>nul</strong>.`);
        Audio.ping(300,.1); setTimeout(()=>Audio.ping(240,.12),60); haptic([10,40,10]);
      }
      cells.forEach(c => c.disabled = true);
      state.starter = state.starter==='X' ? 'O' : 'X';
      setTimeout(()=>resetBtn.focus(),120);
      save();

      if(online.connected && source==='local'){
        send({t:'end'});
      }
    }
    function resetBoard(keepScores=true, source='local'){
      state.board.fill(null);
      state.moves = 0;
      state.player = state.starter;
      state.lock = false;
      state.history.length = 0;

      cells.forEach((c,i)=>{
        c.innerHTML=''; c.classList.remove('win'); c.disabled=false;
        c.setAttribute('aria-label',`Case ${i+1}`);
      });
      setTurnLabel(`C’est à <strong>${state.player}</strong> de jouer.`);
      updateProgress();

      if(!keepScores){ state.scores={X:0,O:0,D:0}; state.starter='X'; renderScores(); }
      emptyState.classList.remove('hide'); undoBtn.disabled = true; save();

      if(online.connected && source==='local'){
        send({t:'reset', keepScores});
      }
    }
    function undo(source='local'){
      if(state.history.length===0) return;
      state.lock = false;

      const idx = state.history.pop();
      state.board[idx] = null; state.moves--;
      cells[idx].innerHTML=''; cells[idx].classList.remove('win'); cells[idx].disabled=false;
      cells[idx].setAttribute('aria-label', `Case ${idx+1}`);

      state.player = state.player==='X' ? 'O' : 'X';
      setTurnLabel(`C’est à <strong>${state.player}</strong> de jouer.`);
      updateProgress(); save();
      if(state.history.length===0) undoBtn.disabled = true;

      if(online.connected && source==='local'){
        send({t:'undo'});
      }
    }

    // === Interactions plateau ===
    boardEl.addEventListener('click', e=>{
      const btn = e.target.closest('.cell'); if(!btn) return;
      placeMark(+btn.dataset.index, 'local');
    });
    boardEl.addEventListener('keydown', e=>{
      const current = document.activeElement.closest('.cell'); if(!current) return;
      const idx = +current.dataset.index;
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); placeMark(idx, 'local'); return; }
      if(e.key==='ArrowRight' || e.key==='ArrowLeft' || e.key==='ArrowDown' || e.key==='ArrowUp'){
        e.preventDefault();
        let next = idx;
        for(let i=0;i<9;i++){
          next = e.key==='ArrowRight' ? (next%3<2?next+1:next-2)
               : e.key==='ArrowLeft'  ? (next%3>0?next-1:next+2)
               : e.key==='ArrowDown'  ? (next<6?next+3:next-6)
               : /* ArrowUp */          (next>2?next-3:next+6);
          if(!cells[next].disabled){ cells[next].focus(); break; }
        }
      }
    });
    window.addEventListener('keydown', e=>{
      if(e.target.closest('input,textarea,select,button,[contenteditable]')) return;
      if((e.key==='z'||e.key==='Z') && (e.ctrlKey || !e.metaKey) && !e.shiftKey){ e.preventDefault(); undo('local'); }
      if(e.key==='r'||e.key==='R'){ e.preventDefault(); resetBoard(true,'local'); }
    });

    resetBtn.addEventListener('click', ()=>resetBoard(true,'local'));
    resetSeriesBtn.addEventListener('click', ()=>{
      if(confirm('Réinitialiser la série (scores + plateau) ?')) resetBoard(false,'local');
    });
    undoBtn.addEventListener('click', ()=>undo('local'));
    soundBtn.addEventListener('click', ()=>{
      state.sounds = !state.sounds;
      updateSoundUI(); save();
    });

    // === Modal (a11y + focus trap) ===
    let prevFocus=null;
    function openModal(){
      modal.setAttribute('open','');
      modal.removeAttribute('aria-hidden');
      prevFocus = document.activeElement;
      modal.addEventListener('keydown', trapTab);
      nickInput.focus();
    }
    function closeModal(){
      modal.removeAttribute('open');
      modal.setAttribute('aria-hidden','true');
      modal.removeEventListener('keydown', trapTab);
      prevFocus && prevFocus.focus();
    }
    onlineBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.hasAttribute('open')) closeModal(); });
    function trapTab(e){
      if(e.key!=='Tab') return;
      const f = modal.querySelectorAll('button, [href], input, textarea, select, [tabindex]:not([tabindex="-1"])');
      if(!f.length) return;
      const first = f[0], last = f[f.length-1];
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }

    function switchTab(target){
      const isHost = target==='host';
      tabHost.setAttribute('aria-selected', String(isHost));
      tabJoin.setAttribute('aria-selected', String(!isHost));
      panelHost.hidden = !isHost;
      panelJoin.hidden = isHost;
      sideChip.textContent = isHost ? 'Tu joueras : X (hôte) · O (invité)' : 'Tu joueras : O (invité) · X (hôte)';
    }
    tabHost.addEventListener('click', ()=>switchTab('host'));
    tabJoin.addEventListener('click', ()=>switchTab('join'));

    // === WebRTC (copier-coller + liens) ===
    const ICE_SERVERS = [{urls:'stun:stun.l.google.com:19302'}];

    function newPC(){
      const pc = new RTCPeerConnection({iceServers: ICE_SERVERS});
      pc.addEventListener('iceconnectionstatechange', ()=>{
        const s = pc.iceConnectionState;
        if(s==='connected' || s==='completed'){
          online.connected = true;
          setNetChip('Connecté', true);
          startPing();
          closeModal();
        }else if(s==='disconnected'){
          setNetChip('Déconnecté'); stopPing();
        }else if(s==='failed'){
          setNetChip('Échec de connexion'); stopPing(); teardownOnline();
          alert('Connexion échouée. Vous pouvez rejouer en local.');
        }
      });
      return pc;
    }
    function waitIceDone(pc){
      if(pc.iceGatheringState==='complete') return Promise.resolve();
      return new Promise(res=>{
        function check(){
          if(pc.iceGatheringState==='complete'){ pc.removeEventListener('icegatheringstatechange', check); res(); }
        }
        pc.addEventListener('icegatheringstatechange', check);
        setTimeout(()=>res(), 3000);
      });
    }

    function send(obj){
      try{
        if(online.dc && online.dc.readyState==='open'){
          online.dc.send(JSON.stringify(obj));
        }
      }catch{}
    }
    function startPing(){
      stopPing();
      online.pingTimer = setInterval(()=>{
        const ts = Date.now();
        send({t:'ping', ts});
      }, 2000);
    }
    function stopPing(){ if(online.pingTimer){ clearInterval(online.pingTimer); online.pingTimer=null; } }

    function handleMessage(ev){
      let msg; try{ msg = JSON.parse(ev.data); }catch{ return; }
      switch(msg.t){
        case 'hello':
          online.peerNick = msg.nick || '';
          break;
        case 'sync':
          if(online.role==='guest'){
            state = {...state, ...msg.state};
            hydrateBoard();
          }
          break;
        case 'move': placeMark(msg.i, 'remote'); break;
        case 'undo': undo('remote'); break;
        case 'reset': resetBoard(!!msg.keepScores, 'remote'); break;
        case 'end': break;
        case 'ping': send({t:'pong', ts: msg.ts}); break;
        case 'pong':
          online.ping = Math.max(0, Date.now() - msg.ts);
          setNetChip(`Connecté • ${online.ping} ms`, true);
          break;
      }
    }

    function setupDC(dc){
      online.dc = dc;
      dc.addEventListener('open', ()=>{
        online.connected = true;
        setNetChip('Connecté', true);
        send({t:'hello', nick: online.nick});
        if(online.role==='host'){ send({t:'sync', state}); }
        startPing();
        updatePlayableHint();
      });
      dc.addEventListener('message', handleMessage);
      dc.addEventListener('close', ()=>{ setNetChip('Hors ligne'); stopPing(); online.connected=false; updatePlayableHint(); });
      dc.addEventListener('error', ()=>{ setNetChip('Erreur'); });
    }

    function teardownOnline(){
      try{ online.dc && online.dc.close(); }catch{}
      try{ online.pc && online.pc.close(); }catch{}
      online.dc = null; online.pc = null; online.connected=false; online.role=null;
      setNetChip('Hors ligne');
      updatePlayableHint();
    }

    // — Hôte (X)
    hostCreateBtn.addEventListener('click', async ()=>{
      teardownOnline();
      online.role='host'; online.side='X'; online.enabled=true;
      updatePlayableHint();
      const pc = online.pc = newPC();
      const dc = pc.createDataChannel('game');
      setupDC(dc);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await waitIceDone(pc);

      const payload = {type:'offer', sdp: pc.localDescription.sdp, v:1};
      const b64 = encode(payload);
      hostOfferTA.value = toUrlSafe(b64); // lisible/utilisable aussi en code
      const link = makeInviteLink(payload);
      hostOfferLinkTA.value = link;
      hostCopyLinkBtn.disabled = false;
      hostShareBtn.disabled = false;
      applyAnswerBtn.disabled = false;
      setNetChip('En attente de réponse…');
    });

    hostCopyLinkBtn.addEventListener('click', async ()=>{
      if(!hostOfferLinkTA.value) return;
      await copyAny(hostOfferLinkTA.value, hostCopyLinkBtn);
    });
    hostShareBtn.addEventListener('click', async ()=>{
      if(!hostOfferLinkTA.value) return;
      await shareUrlOrCopy(hostOfferLinkTA.value, hostShareBtn, 'Rejoins ma partie de Tic‑Tac‑Toe+');
    });

    applyAnswerBtn.addEventListener('click', async ()=>{
      const raw = guestAnswerTA.value.trim(); if(!raw) return;
      try{
        const ans = decode(raw); // accepte base64 ou base64url
        if(ans.type!=='answer') throw new Error('Type invalide');
        await online.pc.setRemoteDescription({type:'answer', sdp: ans.sdp});
        // Nettoie le hash “answer” si présent
        history.replaceState(null,'',location.pathname + location.search);
        setNetChip('Connexion…');
      }catch(e){
        alert('Réponse invalide.');
      }
    });

    // — Invité (O)
    joinApplyOfferBtn.addEventListener('click', async ()=>{
      const raw = hostOfferInputTA.value.trim(); if(!raw) return;
      try{
        teardownOnline();
        online.role='guest'; online.side='O'; online.enabled=true;
        updatePlayableHint();
        const pc = online.pc = newPC();
        pc.ondatachannel = (e)=> setupDC(e.channel);

        const offer = decode(raw);
        if(offer.type!=='offer') throw new Error('Type invalide');
        await pc.setRemoteDescription({type:'offer', sdp: offer.sdp});
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitIceDone(pc);

        const payload = {type:'answer', sdp: pc.localDescription.sdp, v:1};
        const b64 = encode(payload);
        joinAnswerTA.value = toUrlSafe(b64);
        const link = makeAnswerLink(payload);
        joinAnswerLinkTA.value = link;
        joinCopyLinkBtn.disabled = true; // on réactive après remplissage setTimeout pour éviter double clic
        joinShareBtn.disabled = true;
        setTimeout(()=>{ joinCopyLinkBtn.disabled=false; joinShareBtn.disabled=false; }, 50);
        setNetChip('Réponse prête, envoie le lien à l’hôte.');
      }catch(e){
        alert('Invitation invalide.');
      }
    });

    joinCopyLinkBtn.addEventListener('click', async ()=>{
      if(!joinAnswerLinkTA.value) return;
      await copyAny(joinAnswerLinkTA.value, joinCopyLinkBtn);
    });
    joinShareBtn.addEventListener('click', async ()=>{
      if(!joinAnswerLinkTA.value) return;
      await shareUrlOrCopy(joinAnswerLinkTA.value, joinShareBtn, 'Voici ma réponse Tic‑Tac‑Toe+');
    });

    // Pseudo
    try{
      const savedNick = localStorage.getItem(NICK_KEY);
      if(savedNick) nickInput.value = savedNick;
    }catch{}
    nickInput.addEventListener('input', ()=>{
      online.nick = nickInput.value.slice(0,40);
      try{ localStorage.setItem(NICK_KEY, online.nick); }catch{}
    });

    // === Deep‑link URL (search/hash) ===
    (function deepLinkOnline(){
      const p = new URLSearchParams(location.search);
      if (p.get('online') === 'host') { openModal(); switchTab('host'); }
      else if (p.get('online') === 'join') { openModal(); switchTab('join'); }
      // Hash “offer” → préremplir le champ invité
      if(location.hash){
        const hp = new URLSearchParams(location.hash.slice(1));
        if(hp.get('offer')){
          const offerStr = hp.get('offer');
          openModal(); switchTab('join');
          hostOfferInputTA.value = offerStr; // decode() acceptera base64url
          // On ne lance pas automatiquement, l’utilisateur reste maître du clic
        }
        if(hp.get('answer')){
          const answerStr = hp.get('answer');
          openModal(); switchTab('host');
          guestAnswerTA.value = answerStr; // decode() gère base64url
          // Auto-validation pour fluidifier (pas de permission requise)
          applyAnswerBtn.click();
        }
      }
    })();

    // === Init ===
    function init(){
      cells.forEach((c,i)=>c.setAttribute('tabindex', i===0 ? '0' : '-1'));
      boardEl.addEventListener('focusin',()=>{ cells.forEach(c=>c.setAttribute('tabindex','0')); }, {once:true});
      load();
      if(state.moves===0 && !state.board.some(Boolean)){ resetBoard(true,'local'); }
      setNetChip('Hors ligne');
      online.nick = nickInput.value || '';
      updatePlayableHint();
    }
    init();
  </script>
</body>
</html>
